@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix dc: <http://purl.org/dc/elements/1.1/> .
@base <https://foerderfunke.org/default#> .

#################################################################
#    METADATA
#################################################################

<Kinderzuschlag> a <FundingProgram> ;
    <idlb> "B100019.LB.581863" ;
    dc:title "Kinderzuschlag"@de ;
    dc:description "Wenn Sie als Eltern genug Einkommen für sich selbst verdienen, aber das Einkommen nicht oder nur knapp für die gesamte Familie reicht, können Sie den Kinderzuschlag beantragen."@de . 
    
#################################################################
#    CONSTRAINTS
#################################################################

<KinderzuschlagShape> a sh:NodeShape;
    <checksFundingProgram> <Kinderzuschlag> ;
    sh:targetClass <User> ;
    sh:property <ChildProperty>;
    sh:or (
            <IncomeShapeA>
            <IncomeShapeB>
    ) ;
    sh:property <PriorityClaimsProperty> ;
    sh:property <WarningProperty> . # Ambiguous constraints that require more information

# Must have at least one child that conforms to the ChildShape
<ChildProperty> a sh:PropertyShape ;
    sh:path <hasChild> ;
    sh:qualifiedValueShape <ChildShape> ;
    sh:qualifiedMinCount 1 ;
    sh:message "Sie müssen mindestens ein Kind haben, das jünger als 25 Jahre alt ist, nicht verheiratet oder verpartnert ist, in Ihrem Haushalt lebt und Kindergeld empfängt".

# Child must be younger than 25, unmarried, live in the same household, and receive child benefit
<ChildShape> a sh:NodeShape ;
    sh:targetClass <Child> ;
    sh:and (
        [
            sh:path <age> ; 
            sh:minCount 1 ;
            sh:maxExclusive "25" ;
            sh:datatype xsd:integer ;
        ]
        [
            sh:path <hasMaritalStatus> ;
            sh:minCount 1 ;
            sh:Value <Single> ;
        ]
        [
            sh:path <sameHouseholdAs> ;
            sh:minCount 1 ;
            sh:class <User> ; # We assume that there will always only be one user
        ]
        [
            sh:path <receivesChildBenefit> ;
            sh:minCount 1 ;
            sh:minInclusive 1 ;
        ]
    ) .

# If the user is not a single parent, their gross income must be at least 900 Euros
<IncomeShapeA> a sh:NodeShape ;
    sh:property [
                sh:path <singleParent> ;
                sh:maxCount 1 ;
                sh:hasValue "false" ;
    ] ;
    sh:property [
                sh:path <grossIncome> ;
                sh:minCount 1 ;
                sh:minInclusive "900" ;
                sh:datatype xsd:float ;
    ] .

# If the user is a single parent, their gross income must be at least 600 Euros
<IncomeShapeB> a sh:NodeShape ;
    sh:property [
                sh:path <singleParent> ;
                sh:minCount 1 ;
                sh:hasValue true ;
    ] ;
    sh:property[
                sh:path <grossIncome> ;
                sh:minCount 1 ;
                sh:minInclusive "600" ;
                sh:datatype xsd:float ;
    ] .

# User must check if the child is eligible for other claims with priority (e.g., alimony)
<PriorityClaimsProperty> a sh:PropertyShape ;
    sh:path <checkedPriorityClaims> ;
    sh:minCount 1 ;
    sh:hasValue true ;
    sh:severity sh:Warning ;
    sh:message "Der Kinderzuschlag ist nachrangig gegenüber anderen möglichen Einkünften des Kindes; gegebenenfalls besteht die Verpflichtung, sich um vorrangige Ansprüche wie Unterhalt oder Unterhaltsvorschuss zu bemühen."@de.

# Shape that will always be invalid and trigger warning
# TODO: Split up into individual properties. 
<WarningProperty> a sh:PropertyShape ;
    sh:path <NonExistentPath>;
    sh:minCount 1 ;
    sh:severity sh:Warning ;
    sh:message "Zusätzlich zu beachten: Ihr anzurechnendes Einkommen darf den Kinderzuschlag nicht auf null reduzieren. Sie dürfen über kein erhebliches Vermögen verfügen. Ihr Gesamteinkommen, inklusive Kindergeld, Wohngeld und Kinderzuschlag, muss den Bedarf der Familie nach SGB II decken."@de .