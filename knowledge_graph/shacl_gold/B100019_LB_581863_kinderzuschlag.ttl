@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix dc: <http://purl.org/dc/elements/1.1/> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix ff: <https://foerderfunke.org/default#> .

#################################################################
#    METADATA
#################################################################

ff:Kinderzuschlag a ff:FundingProgram ;
    ff:idlb "B100019.LB.581863" ;
    dc:title "Kinderzuschlag"@de ;
    dc:description "Wenn Sie als Eltern genug Einkommen für sich selbst verdienen, aber das Einkommen nicht oder nur knapp für die gesamte Familie reicht, können Sie den Kinderzuschlag beantragen."@de . 
    
#################################################################
#    CONSTRAINTS
#################################################################

ff:KinderzuschlagShape a sh:NodeShape;
    ff:checksFundingProgram ff:Kinderzuschlag ;
    sh:targetClass ff:User ;
    sh:property ff:ChildProperty ;
    sh:or (
            ff:IncomeShapeA
            ff:IncomeShapeB
    ) ;
    sh:property ff:PriorityClaimsProperty .
    #sh:property ff:WarningProperty . # Ambiguous constraints that require more information

# Must have at least one child that conforms to the ChildShape
ff:ChildProperty a sh:PropertyShape ;
    sh:path ff:hasChild ;
    sh:qualifiedValueShape ff:ChildShape ;
    sh:qualifiedMinCount 1 ;
    sh:message "Sie müssen mindestens ein Kind haben, das jünger als 25 Jahre alt ist, nicht verheiratet oder verpartnert ist, in Ihrem Haushalt lebt und Kindergeld empfängt".

# Child must be younger than 25, unmarried, live in the same household, and receive child benefit
ff:ChildShape a sh:NodeShape ;
    sh:class ff:Child ;
    sh:property [
            sh:path ff:age ; 
            sh:minCount 1 ;
            sh:maxExclusive 25 ;
            sh:datatype xsd:integer ;
        ] ;
    sh:property [
            sh:path ff:hasMaritalStatus ;
            sh:minCount 1 ;
            sh:in (ff:Single) ;
        ] ;
    sh:property [
            sh:path ff:sameHouseholdAs ;
            sh:minCount 1 ;
            sh:class ff:User ; # We assume that there will always only be one user
        ] ;
    sh:property [
            sh:path ff:receivesChildBenefit ;
            sh:minCount 1 ;
            sh:minInclusive 1 ;
        ] .

# If the user is not a single parent, their gross income must be at least 900 Euros
ff:IncomeShapeA a sh:NodeShape ;
    sh:property [
                sh:path ff:singleParent ;
                sh:maxCount 1 ;
                sh:in (false) ;
    ] ;
    sh:property [
                sh:path ff:grossIncome ;
                sh:minCount 1 ;
                sh:minInclusive 900 ;
    ] .

# If the user is a single parent, their gross income must be at least 600 Euros
ff:IncomeShapeB a sh:NodeShape ;
    sh:property [
                sh:path ff:singleParent ;
                sh:minCount 1 ;
                sh:in (true) ;
    ] ;
    sh:property[
                sh:path ff:grossIncome ;
                sh:minCount 1 ;
                sh:minInclusive 600 ;
    ] .

# User must check if the child is eligible for other claims with priority (e.g., alimony)
ff:PriorityClaimsProperty a sh:PropertyShape ;
    sh:path ff:checkedPriorityClaims ;
    sh:minCount 1 ;
    sh:in (true) ;
    sh:severity sh:Warning ;
    sh:message "Der Kinderzuschlag ist nachrangig gegenüber anderen möglichen Einkünften des Kindes; gegebenenfalls besteht die Verpflichtung, sich um vorrangige Ansprüche wie Unterhalt oder Unterhaltsvorschuss zu bemühen."@de.

# Shape that will always be invalid and trigger warning
# TODO: Split up into individual properties. 
ff:WarningProperty a sh:PropertyShape ;
    sh:path ff:NonExistentPath;
    sh:minCount 1 ;
    sh:severity sh:Warning ;
    sh:message "Zusätzlich zu beachten: Ihr anzurechnendes Einkommen darf den Kinderzuschlag nicht auf null reduzieren. Sie dürfen über kein erhebliches Vermögen verfügen. Ihr Gesamteinkommen, inklusive Kindergeld, Wohngeld und Kinderzuschlag, muss den Bedarf der Familie nach SGB II decken."@de .