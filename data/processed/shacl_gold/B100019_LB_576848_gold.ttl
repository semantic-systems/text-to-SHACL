@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix ff: <https://foerderfunke.org/default#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .

# METADATA

ff:B100019_LB_576848 a ff:SocialBenefit ;
    rdfs:label "Insolvenzgeld"@de, "Insolvency allowance"@en .

# CONSTRAINTS

ff:InsolvenzgeldShape a sh:NodeShape ;
    ff:checksFundingRequirement ff:B100019_LB_576848 ;
    sh:targetNode ff:User ;
    # User is an employee by law
    sh:property [
        sh:path ff:hasEmploymentStatus ;
        sh:minCount 1 ;
        sh:hasValue ff:Employed ;
        sh:message "Does not meet requirement 'User is an employee by law'."@en ;
    ] ;
    # An insolvency event occurred at the user's employer    
    sh:property [
        sh:path ( ff:employedBy ff:hasEvent ) ;
        sh:qualifiedValueShape ff:InsolvencyEventShape ;
        sh:qualifiedMinCount 1 ;
        sh:message "Does not meet requirement 'An insolvency event occurred at the user's employer'."@en ;
	] ;
    # User is employed in Germany OR temporarily abroad and obligated to pay social security in Germany
    sh:or (
        ff:CountryShapeA
        ff:CountryShapeB
    ) .

ff:InsolvencyEventShape a sh:NodeShape ;
    # User wage was cut within 3 months before the insolvency event
    sh:property [
        sh:path ff:wageCutOffsetMonths;
        sh:minCount 1 ;
        sh:minInclusive -3 ; # negative offset = occurred before event, positive offset = occurred after event
		sh:maxInclusive -1 ;
    ] ;
    sh:or (
        ff:InsolvencyProceedingShape
        ff:InsolvencyApplicationShape
        ff:BusinessActivityShape
    ) .

# Insolvency proceedings are opened against the employer's assets
ff:InsolvencyProceedingShape a sh:NodeShape ;
    sh:property [
        sh:path rdf:type ;
        sh:minCount 1 ;
        sh:hasValue ff:OpeningInsolvencyProceeding ;
    ] ;
    sh:property [
        sh:path ff:isOngoing ;
        sh:minCount 1 ;
        sh:hasValue true ;
    ] .

# Insolvency application is rejected for lack of assets 
ff:InsolvencyApplicationShape a sh:NodeShape ;
    sh:property [
        sh:path rdf:type ;
        sh:minCount 1 ;
        sh:hasValue ff:RejectionInsolvencyApplication ;
    ] ;
    sh:property [
        sh:path ff:reason ;
        sh:minCount 1 ;
        sh:in ( "Lack of assets"@en "Mangels Masse"@de ) ;
    ] .

# Business activity is completely discontinued AND there is an obvious lack of assets
ff:BusinessActivityShape a sh:NodeShape ;
    sh:property [
        sh:path rdf:type ;
        sh:minCount 1 ;
        sh:hasValue ff:DiscontinuationOfBusinessActivity ;
    ] ;
    sh:property [
        sh:path ff:obviousLackOfAssets ;
        sh:minCount 1 ;
        sh:hasValue true ;
    ] .

# User is employed in Germany
ff:CountryShapeA a sh:NodeShape ;
    sh:property [
        sh:path ff:countryOfEmployment ;
        sh:minCount 1 ;
        sh:hasValue ff:Germany ;
    ] .

# User is employed abroad AND subject to social security in Germany
ff:CountryShapeB a sh:NodeShape ;
    sh:property [
        sh:path ff:countryOfEmployment ;
        sh:minCount 1;
        sh:not [
            sh:hasValue ff:Germany
        ]
    ] ;
    sh:property [
        sh:path ff:socialSecurityCountry ;
        sh:minCount 1 ;
        sh:hasValue ff:Germany ;
    ] .